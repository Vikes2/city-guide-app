{% extends 'base.html' %} 
{% load staticfiles %} 
{% block body %}
<div class="modal fade add-break" tabindex="-1" role="dialog" aria-labelledby="Dodaj przerwę" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj przerwę</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{% url 'city_guide:planner_add_break' tour.id %}" id="add-break-form" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="id">
                    {% for field in break_form %}
                    {% if field.errors %}
                    <div class="alert alert-danger">
                        {{ field.errors}}
                    </div>
                    {% endif %}
                    <div class="form-group row">
                        <label class="col-form-label col-sm-3" for="{{field.id_for_label}}">{{field.label}}:</label>
                        <div class="col-sm-9">
                            {{field}}
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col offset-sm-3">
                        <button type="submit" class="btn btn-primary">Dodaj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid standard-container">
    <div class="row mt-5">
        <div class="mx-auto">
            <h3>Planowanie podróży</h3>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-5 px-4">
            <div class="row">
                <div class="mx-auto">
                    <h1>Przebieg podróży</h1>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <h4>Ustawienia</h4>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="is-start-point" checked>
                        <label class="form-check-label" for="is-start-point">Chcę ustawić startu</label>
                    </div>
                    <div class="form-group row">
                        <label for="start-location-input" class="col-form-label col-sm-4">Punkt startowy</label>
                        <div class="col-sm">
                            <input type="text" id="start-location-input" class="form-control">
                        </div>
                        <div class="col-sm-auto">
                            <button class="btn btn-primary" id="my-location-btn">Moja lokalizacja</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="transport" class="col-form-label col-sm-4">Podróżuję</label>
                        <div class="col-sm">
                            <select id="transport" class="form-control">
                                <option value="DRIVING">Samochodem</option>
                                <option value="WALKING">Pieszo</option>
                                <option value="BICYCLING">Rowerem</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <button class="btn btn-sm btn-success" data-toggle="modal" data-target=".add-break">Dodaj przerwę</button>                                            
                    <ul id="sortable">
                        {% for attraction, orders in cart.items %}
                        <li class="ui-state-default attraction my-2" data-lat="{{attraction.location_x}}" data-lng="{{attraction.location_y}}" data-id="{{attraction.id}}" data-type="{{orders.type}}">
                            {% if orders.type == "break" %}
                            <div class="card alert-info">
                            {% else %}
                            <div class="card">
                            {% endif %}
                                <div class="card-body">
                                    {% if orders.type == "attraction" %}
                                    <div class="row">
                                        <div class="col attractionTitleInPlanner">
                                            {{ attraction }}
                                        </div>
                                        <div class="col-4">
                                            <div class="row">
                                                <div class="col">
                                                    <span class="fontForAll">
                                                        <i class="fa fa-clock"></i> {{ attraction.time_minutes }} min
                                                    </span>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-danger btn-sm float-right ml-2">Usuń</button>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-warning btn-sm float-right mr-2">Edycja</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            Wskazówki dojścia
                                            <div class="route-steps" style="display: none;"></div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="row">
                                        <div class="col attractionTitleInPlanner">
                                            {{ attraction.name }}
                                        </div>
                                        <div class="col-4">
                                            <div class="row">
                                                <div class="col">
                                                    <span class="fontForAll">
                                                        <i class="fa fa-clock"></i> {{ attraction.time }} min
                                                    </span>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-danger btn-sm float-right ml-2">Usuń</button>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-warning btn-sm float-right mr-2">Edycja</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                        <button class="btn btn-primary btn-block mt-2" id="generateBtn">Generuj Trasę</button>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col px-4">
            <div class="row">
                <div class="col">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <span class="fontforAll">
                                <i class="fa fa-clock"></i> Łączny czas zwiedzania: {{ total_time }}
                            </span>
                        </div>
                        <div class="col">
                            <span class="fontforAll">
                                <i class="fa fa-coin"></i> Łączny koszt wycieczki: {{ total_cost }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div id="directions-panel"></div>
        </div>
    </div>
</div>
{% endblock %} 

{% block javascripts %} 

{{ block.super }}

<script>
    let newOrder = {};
    let order = "{{tour.attraction_order}}";
    let startPoint;
    let isStartPoint = $('#is-start-point')[0].checked;
    let startLocationInput = $('#start-location-input');
    let startLocation = localStorage.getItem('start-point');
    let dirty = "{{tour.was_order_modified}}" == "True" ? true : false;

    order = JSON.parse(order.replace(/&quot;/g, "\""));

    $('#start-location-input').prop('disabled', !($('#is-start-point')[0].checked));

    $('#add-break-form').submit(function(e){
        let url = $(this).attr("action");

        $.ajax({
            url: url,
            type: 'POST',
            data: $(this).serialize(),
            success: function (data) {
                location.reload();
            }
        });

        e.preventDefault();
    });

    $('#is-start-point').on('change', function(){
        $('#start-location-input').prop('disabled', !($('#is-start-point')[0].checked));
        isStartPoint = $('#is-start-point')[0].checked;     
    });

    $('#my-location-btn').on('click', function(){
        $('#map').html("ladowanie");
        navigator.geolocation.getCurrentPosition((position) => {
            myPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            }
            getAjax();
            function getAjax(){
                $.ajax({
                    url: 'https://maps.googleapis.com/maps/api/geocode/json?latlng=' + myPos.lat + ',' + myPos.lng + '&key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU'
                }).done(function(data){
                    if(data.status == "OK"){
                        let address = data.results[0]['formatted_address'];
                        startLocationInput.val(address);
                        localStorage.setItem('start-point', address);
                        initMap();
                    } else{
                        setTimeout(getAjax, 1000);
                    }
                });
            }
        }, () => {
           alert("to do");
        });
    });

    $('#generateBtn').on('click', function(){
        if(startLocationInput.val() != ""){
            getAjax();
            function getAjax(){
                $.ajax({
                    url: apiUrl = 'https://maps.google.com/maps/api/geocode/json?address=' + startLocationInput.val() + '&key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU'
                }).done(function(data){
                    if(data.status == "OK"){
                        let address = data.results[0]['formatted_address'];
                        startLocation = address;
                        startLocationInput.val(address);
                        localStorage.setItem('start-point', address);
                        initMap();
                    } else{
                        setTimeout(getAjax, 1000);
                    }
                });
            }
        } else{
            localStorage.setItem('start-point', "");
            initMap();
        }
    });

    $(function () {
        $('#sortable').sortable({
            update: function (event, ui) {
                $('.attraction').each(function (e) {
                    let type = $(this).attr("data-type");
                    //let type = "attraction";
                    let id = $(this).attr("data-id");
                    newOrder[$(this).index().toString()] = {};
                    newOrder[$(this).index().toString()][type] = id;
                    console.log(newOrder);
                });
                $.ajax({
                    url: "{% url 'city_guide:planner_edit' tour.id %}",
                    type: 'GET',
                    data: { order: JSON.stringify(newOrder) },
                    dataType: 'json'
                });
            }
        });
    })

    function initMap() {
        isStartPoint = $('#is-start-point')[0].checked;        
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 6,
            center: { lat: 41.85, lng: -87.65 }
        });

        directionsDisplay.setMap(map);

        let lat_beg = parseFloat($('.attraction').first().attr('data-lat'));
        let lng_beg = parseFloat($('.attraction').first().attr('data-lng'));  

        if(isStartPoint && startLocation != "" && startLocation != undefined){
            getAjax();
            function getAjax(){
                $.ajax({
                    url: apiUrl = 'https://maps.google.com/maps/api/geocode/json?address=' + startLocation + '&key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU'
                }).done(function(data){
                    if(data.status == "OK"){
                        let address = data.results[0]['formatted_address'];
                        startLocation = address;
                        startLocationInput.val(address);
                        calculateAndDisplayRoute(directionsService, directionsDisplay, data.results[0].geometry.location);
                    } else{
                        setTimeout(getAjax, 1000);
                    }
                });
            }
        } else{
            calculateAndDisplayRoute(directionsService, directionsDisplay, {lat: lat_beg, lng: lng_beg});
        }
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay, pos) {
        var waypts = [];
        let coords;
        let transport = $('#transport').val();
        
        console.log(pos);
    
        $('.attraction').not(':last').each(function () {
            if(!isStartPoint && $(this).is(':first-child'))
                return;
            
            let lat = parseFloat($(this).attr('data-lat'));
            let lng = parseFloat($(this).attr('data-lng'));

            if(isNaN(lat) || isNaN(lng))
                return;

            waypts.push({
                location: new google.maps.LatLng({ lat: lat, lng: lng }),
                stopover: true
            });
        });

        let lat_end = parseFloat($('.attraction').last().attr('data-lat'));
        let lng_end = parseFloat($('.attraction').last().attr('data-lng'));
        if(!startLocation){
            let lat_beg = parseFloat($('.attraction').first().attr('data-lat'));
            let lng_beg = parseFloat($('.attraction').first().attr('data-lng'));                    
            coords = { lat: lat_beg, lng: lng_beg };
        } else{
            coords = { lat: pos.lat, lng: pos.lng };
        }

        directionsService.route({
            origin: new google.maps.LatLng(coords),
            destination: new google.maps.LatLng({ lat: lat_end, lng: lng_end }),
            waypoints: waypts,
            optimizeWaypoints: dirty ? false : true,
            travelMode: transport
        }, function (response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
                var route = response.routes[0];
                var summaryPanel = document.getElementById('directions-panel');
                summaryPanel.innerHTML = '';
                // For each route, display summary information.
                console.log(route);
                var i = 0;
                $('.route-steps').each(function(){
                    $(this).html("");
                })
                $('.attraction').each(function(){
                    steps = $(this).find('.route-steps');
                    var string = "";
                    for(var j = 0; j < route.legs[i].steps.length; j++){
                        string += route.legs[i].steps[j].instructions + "<br>";
                    }
                    steps.html(string);

                    if(i < route.legs.length)
                        i++;
                });
                //if(isStartPoint){
                    //d = document.createElement('div');
                   // $(d).attr('id', "block-0");
                   // d.innerHTML += route.legs[0].start_address + ' to ';
                  //  d.innerHTML += route.legs[0].end_address + '<br>';
                   // d.innerHTML += route.legs[0].distance.text + '<br><br>';
                 //   $('#sortable').prepend(d);
                //}
                //$('.attraction').not
                //for (var i = 0; i < route.legs.length; i++) {
                    //var routeSegment = i + 1;
                       // summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
                        //    '</b><br>';
                      //  summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
                    //    summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
                  //      summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
                //}
            } else {
                window.alert('Directions request failed due to ' + status);
            }
        });
    }

    $(function () {
        // $("#sortable").sortable({
        //    revert: true
        //});
        $("#draggable").draggable({
            connectToSortable: "#sortable",
            helper: "clone",
            revert: "invalid"
        });
        $("ul, li").disableSelection();
        //var sorted = $( ".attraction" ).sortable( "serialize", { key: "sort" } );
    });

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU&callback=initMap">
</script> 

{% endblock %}