{% extends 'base.html' %} 
{% load staticfiles %} 
{% block title%} Planowanie trasy {% endblock %} 
{% block body %}
<div class="modal fade add-break" tabindex="-1" role="dialog" aria-labelledby="Dodaj przerwę" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj przerwę</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{% url 'city_guide:planner_add_break' tour.id %}" id="add-break-form" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="id">
                    {% for field in break_form %}
                    {% if field.errors %}
                    <div class="alert alert-danger">
                        {{ field.errors}}
                    </div>
                    {% endif %}
                    <div class="form-group row">
                        <label class="col-form-label col-sm-3" for="{{field.id_for_label}}">{{field.label}}:</label>
                        <div class="col-sm-9">
                            {{field}}
                        </div>
                    </div>
                    {% endfor %}
                    <div class="col offset-sm-3">
                        <button type="submit" class="btn btn-primary">Dodaj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid standard-container">
    <div class="row mt-5">
        <div class="mx-auto">
            <h3>Planowanie podróży</h3>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-5 px-4">
            <div class="row">
                <div class="mx-auto">
                    <h1>Przebieg podróży</h1>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <h4>Ustawienia</h4>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group form-check">
                        <input type="checkbox" class="form-check-input" id="is-start-point" checked>
                        <label class="form-check-label" for="is-start-point">Chcę ustawić startu</label>
                    </div>
                    <div class="form-group row">
                        <label for="start-location-input" class="col-form-label col-sm-4">Punkt startowy</label>
                        <div class="col-sm">
                            <input type="text" id="start-location-input" class="form-control">
                        </div>
                        <div class="col-sm-auto">
                            <button class="btn btn-primary" id="my-location-btn">Moja lokalizacja</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="transport" class="col-form-label col-sm-4">Podróżuję</label>
                        <div class="col-sm">
                            <select id="transport" class="form-control">
                                <option value="DRIVING">Samochodem</option>
                                <option value="WALKING">Pieszo</option>
                                <option value="BICYCLING">Rowerem</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <button class="btn btn-sm btn-success" data-toggle="modal" data-target=".add-break">Dodaj przerwę</button>                                            
                    <ul id="sortable">
                        {% for attraction, orders in cart.items %}
                        <li class="ui-state-default order-item {{ orders.type }} my-2" data-lat="{{attraction.location_x}}" data-lng="{{attraction.location_y}}" data-id="{{attraction.id}}" data-type="{{orders.type}}">
                            {% if orders.type == "break" %}
                            <div class="card alert-info">
                            {% else %}
                            <div class="card">
                            {% endif %}
                                <div class="card-body">
                                    {% if orders.type == "attraction" %}
                                    <div class="row">
                                        <div class="col attractionTitleInPlanner">
                                            {{ attraction }}
                                        </div>
                                        <div class="col-4">
                                            <div class="row">
                                                <div class="col">
                                                    <span class="fontForAll">
                                                        <i class="fa fa-clock"></i> {{ attraction.time_minutes }} min
                                                    </span>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-danger btn-sm float-right ml-2">Usuń</button>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-warning btn-sm float-right mr-2">Edycja</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            Wskazówki dojścia
                                            <div class="route-steps" style="display: none;"></div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="row">
                                        <div class="col attractionTitleInPlanner">
                                            {{ attraction.name }}
                                        </div>
                                        <div class="col-4">
                                            <div class="row">
                                                <div class="col">
                                                    <span class="fontForAll">
                                                        <i class="fa fa-clock"></i> {{ attraction.time }} min
                                                    </span>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-danger btn-sm float-right ml-2">Usuń</button>
                                                </div>
                                                <div class="col-auto px-1">
                                                    <button class="btn btn-warning btn-sm float-right mr-2">Edycja</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    <button class="btn btn-primary btn-block mt-2" id="generateBtn">Generuj Trasę</button>
                </div>
            </div>
        </div>
        <div class="col px-4">
            <div class="row">
                <div class="col">
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <span class="fontforAll">
                                <i class="fa fa-clock"></i> Łączny czas zwiedzania: {{ total_time }}
                            </span>
                        </div>
                        <div class="col">
                            <span class="fontforAll">
                                <i class="fa fa-coin"></i> Łączny koszt wycieczki: {{ total_cost }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div id="directions-panel"></div>
        </div>
    </div>
</div>
{% endblock %} 

{% block javascripts %} 

{{ block.super }}

<script type="text/javascript">
    let mapId = 'map';
    let waypts = "{{ waypoints }}";
    waypts = JSON.parse(waypts.replace(/&quot;/g, "\""));
    let dirty = "{{tour.was_order_modified}} == True" ? true : false;
    var startLocation = localStorage.getItem('start-point');
    if(!startLocation){
        localStorage.setItem('is-start-point', false);
        startLocation = localStorage.getItem('start-point');
        $('#is-start-point').prop('checked', false);
    }

    if(localStorage.getItem('is-start-point') == "true"){
        $('#is-start-point').prop('checked', true);
    } else{
        $('#is-start-point').prop('checked', false);
    }
    
    $('#start-location-input').prop('disabled', !($('#is-start-point')[0].checked));
</script>
<script type="text/javascript" src="{% static 'js/map.js' %}"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU"></script> 
<script type="text/javascript">
    init(waypts);
    let newOrder = {};
    let order = "{{tour.attraction_order}}";

    order = JSON.parse(order.replace(/&quot;/g, "\""));

    $('#add-break-form').submit(function(e){
        let url = $(this).attr("action");

        $.ajax({
            url: url,
            type: 'POST',
            data: $(this).serialize(),
            success: function (data) {
                location.reload();
            }
        });

        e.preventDefault();
    });

    $('#is-start-point').on('change', function(){
        $('#start-location-input').prop('disabled', !($('#is-start-point')[0].checked));
        isStartPoint = $('#is-start-point')[0].checked;
        localStorage.setItem('is-start-point', isStartPoint);     
    });

    $('#my-location-btn').on('click', function(){
        navigator.geolocation.getCurrentPosition((position) => {
            origin = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            }
            getAjax();
            function getAjax(){
                $.ajax({
                    url: 'https://maps.googleapis.com/maps/api/geocode/json?latlng=' + position.coords.latitude + ',' + position.coords.longitude + '&key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU'
                }).done(function(data){
                    if(data.status == "OK"){
                        let address = data.results[0]['formatted_address'];
                        startLocationInput.val(address);
                        localStorage.setItem('start-point', address);
                        startLocation = address;
                        initMap();
                    } else{
                        setTimeout(getAjax, 1000);
                    }
                });
            }
        }, () => {
           alert("to do");
        });
    });

    $('#generateBtn').on('click', function(){
        if(startLocationInput.val() != ""){
            getAjax();
            function getAjax(){
                $.ajax({
                    url: apiUrl = 'https://maps.google.com/maps/api/geocode/json?address=' + startLocationInput.val() + '&key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU'
                }).done(function(data){
                    if(data.status == "OK"){
                        let address = data.results[0]['formatted_address'];
                        startLocation = address;
                        startLocationInput.val(address);
                        localStorage.setItem('start-point', address);
                        initMap();
                    } else{
                        setTimeout(getAjax, 1000);
                    }
                });
            }
        } else{
            localStorage.setItem('start-point', "");
            initMap();
        }
    });

    $(function () {
        $('#sortable').sortable({
            update: function (event, ui) {
                $('.order-item').each(function (e) {
                    let type = $(this).attr("data-type");
                    //let type = "attraction";
                    let id = $(this).attr("data-id");
                    newOrder[$(this).index().toString()] = {};
                    newOrder[$(this).index().toString()][type] = id;
                });
                $.ajax({
                    url: "{% url 'city_guide:planner_edit' tour.id %}",
                    type: 'GET',
                    data: { order: JSON.stringify(newOrder) },
                    dataType: 'json'
                });
            }
        });
    });

    $(function () {
        // $("#sortable").sortable({
        //    revert: true
        //});
        $("#draggable").draggable({
            connectToSortable: "#sortable",
            helper: "clone",
            revert: "invalid"
        });
        $("ul, li").disableSelection();
        //var sorted = $( ".attraction" ).sortable( "serialize", { key: "sort" } );
    });

</script>

{% endblock %}