{% extends 'base.html' %} {% load staticfiles %} {% block body %}
<div class="container" style="margin-top:85px">
    <div class="row">
        <h3 class="col">
            Planowanie podróży
        </h3>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col">
            <div class="card cardPlanner">
                <div class="card-body">
                    <div class="row">
                        <div class="col" style="text-align: center">
                            <h1>
                                Przebieg podróży
                            </h1>
                        </div>
                    </div>

                    <div class="col">
                        <div class="row">
                            <div class="col px-0 mg-0">
                                <div class="row">
                                    <div class="col px-0 mg-0">
                                        <ul id="sortable">
                                            {% for attraction, orders in cart.items %}
                                            <li class="ui-state-default attraction" data-lat="{{attraction.location_x}}" data-lng="{{attraction.location_y}}" data-pos="{{attraction.order.position}}">
                                                <div class="row">
                                                    <div class="col">
                                                        <div class="card py-0">
                                                            <ul class="card-body mb-0">
                                                                <li class="row">
                                                                    <div class="col">
                                                                        <div class="row">
                                                                            <div class="col attractionTitleInPlanner">
                                                                                {{attraction}}
                                                                            </div>
                                                                            <div class="col-4">
                                                                                <div class="row">
                                                                                    <div class="col fa fa-clock px-0 mt-2">
                                                                                        <span class="fontForAll">
                                                                                            <small>
                                                                                                {{attraction.time_minutes}} min
                                                                                            </small>
                                                                                        </span>
                                                                                    </div>
                                                                                    <div class="col px-0 mg-0">
                                                                                        <button type="button" class="btn btn-warning btn-sm ">
                                                                                            <small>Edycja</small>
                                                                                        </button>
                                                                                    </div>
                                                                                    <div class="col px-0 mg-0">
                                                                                        <button type="button" class="btn btn-danger btn-sm">
                                                                                            <small>Usuń</small>
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <!-- <div class="row mt-1">
                                                                            <div class="col">
                                                                                <div class="row cardBody mx-0 my-1 optionPlannerCard">
                                                                                    <div class="col px-0 mg-0">
                                                                                        <div class="col fa fa-clock px-0">
                                                                                            <span class="fontForAll">
                                                                                                <small>
                                                                                                    {{attraction.time_minutes}}
                                                                                                </small>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col px-0 mg-0">
                                                                                        <div class="col fas fa-users px-0">
                                                                                            <span class="fontForAll">
                                                                                                <small>
                                                                                                        {{people_amount}}
                                                                                                </small>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col px-0 mg-0">
                                                                                        <div class="col fas fa-ticket-alt px-0">
                                                                                            <span class="fontForAll">
                                                                                                <small>
                                                                                                    Ulgowe
                                                                                                </small>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="col px-0 mg-0">
                                                                                        <div class="col fas fa-ticket-alt px-0">
                                                                                            <span class="fontForAll">
                                                                                                <small>
                                                                                                    Normalne
                                                                                                </small>
                                                                                            </span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div> -->

                                                                    </div>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                            {% endfor %}
                                            <button class="btn btn-primary" id="generateBtn">
                                                Generuj Trase
                                            </button>
                                        </ul>
                                    </div>
                                </div>


                            </div>
                            <div class="col-5">
                                <div id="map"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card px-0 mx-0">
                <div class="card-body">
                    <div class="row">
                        <div class="col fa fa-clock">
                            <span class="fontForAll">
                                <small>
                                    Łączny czas zwiedzania: {{total_time}}
                                </small>
                            </span>
                        </div>
                        <div class="col fas fa-coin">
                            <span class="fontForAll">
                                <small>
                                    Łączny koszt wycieczki: {{total_cost}} PLN
                                </small>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



{% endblock %} {% block javascripts %} {{ block.super }}

<script>
        function initMap() {
            var directionsService = new google.maps.DirectionsService;
            var directionsDisplay = new google.maps.DirectionsRenderer;
            var map = new google.maps.Map(document.getElementById('map'), {
              zoom: 6,
              center: {lat: 41.85, lng: -87.65}
            });
            directionsDisplay.setMap(map);
     
            document.getElementById('generateBtn').addEventListener('click', function() {
              calculateAndDisplayRoute(directionsService, directionsDisplay);
            });
          }
     
          function calculateAndDisplayRoute(directionsService, directionsDisplay) {
            var waypts = [];
            let myPos = {};
            navigator.geolocation.getCurrentPosition((position) =>{
                myPos = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                }
                  $('.attraction').each(function () {
                      if(!($(this).attr('data-lat') === $('.attraction').last().attr('data-lat') && $(this).attr('data-lng') === $('.attraction').last().attr('data-lng'))){
                          let lat = parseFloat($(this).attr('data-lat'));
                          let lng = parseFloat($(this).attr('data-lng'));
                          waypts.push({
                              location: new google.maps.LatLng({lat: lat, lng: lng}),
                              stopover: true
                            });
                      }
                  });
           
                  let lat_end = parseFloat($('.attraction').last().attr('data-lat'));
                  let lng_end = parseFloat($('.attraction').last().attr('data-lng'));
                  directionsService.route({
                      origin: new google.maps.LatLng({lat: myPos.lat, lng: myPos.lng}),
                      destination: new google.maps.LatLng({lat: lat_end, lng: lng_end}),
                      waypoints: waypts,
                      optimizeWaypoints: true,
                      travelMode: 'DRIVING'
                  }, function(response, status) {
                    if (status === 'OK') {
                      directionsDisplay.setDirections(response);
                      var route = response.routes[0];
                      var summaryPanel = document.getElementById('directions-panel');
                      //summaryPanel.innerHTML = '';
                      // For each route, display summary information.
                      for (var i = 0; i < route.legs.length; i++) {
                        var routeSegment = i + 1;
                        //summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment; //do pdf
                        //summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
                      }
                    } else {
                      window.alert('Directions request failed due to ' + status);
                    }
                  });
            }, () => {
                console.error("Blad");
            });


          }

    $(function () {
        $("#sortable").sortable({
            revert: true
        });
        $("#draggable").draggable({
            connectToSortable: "#sortable",
            helper: "clone",
            revert: "invalid"
        });
        $("ul, li").disableSelection();
    });
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYXIhgWd59IDdrJoO38Tz2hbyoYw0u9TU&callback=initMap">
</script> {% endblock %}